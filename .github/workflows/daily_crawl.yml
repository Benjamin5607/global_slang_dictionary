name: Daily Slang Crawl

on:
  schedule:
    - cron: "0 2 * * *"  # ë§¤ì¼ UTC 02:00 (í•œêµ­ ì‹œê°„ ì˜¤ì „ 11:00) ì‹¤í–‰
  workflow_dispatch:     # GitHub ì›¹ì—ì„œ ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

permissions:
  contents: write        # ë ˆí¬ì§€í† ë¦¬ ì“°ê¸° ê¶Œí•œ (Artifact ì—…ë¡œë“œ ë“±ì— í•„ìš”)

jobs:
  crawl-and-sync:
    runs-on: ubuntu-latest
    
    # crawlers_to_github.pyì—ì„œ ì‚¬ìš©í•  GH_PAT ì‹œí¬ë¦¿ ì£¼ì…
    env:
      GH_PAT: ${{ secrets.GH_PAT }}

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. íŒŒì´ì¬ 3.10 ì„¤ì • (pip ìºì‹œ í™œì„±í™”ë¡œ ì†ë„ í–¥ìƒ)
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      # 3. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # requirements.txt ì—…ë°ì´íŠ¸ë¥¼ ê¹œë¹¡í–ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í•„ìˆ˜ íŒ¨í‚¤ì§€ ê°•ì œ ì„¤ì¹˜
          pip install requests pandas pygithub tqdm beautifulsoup4

      # 4. í¬ë¡¤ëŸ¬ ì‹¤í–‰ (í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ êº¼ëŠ” ì‹¤í–‰ë˜ë„ë¡ ì²˜ë¦¬)
      - name: 1. Run Crawlers
        run: |
          mkdir -p output
          
          echo "ğŸ•·ï¸ Running Urban Dictionary Crawler..."
          python crawlers/urban_dictionary.py || echo "âš ï¸ Urban Dictionary failed, skipping..."

          echo "ğŸ•·ï¸ Running Wiktionary Crawler..."
          python crawlers/wiktionary_slang.py || echo "âš ï¸ Wiktionary failed, skipping..."

          echo "ğŸ•·ï¸ Running Reddit Crawler..."
          python crawlers/reddit_slang.py || echo "âš ï¸ Reddit failed, skipping..."

          echo "ğŸ•·ï¸ Running GitHub List Scavenger..."
          python crawlers/github_lists.py || echo "âš ï¸ GitHub Scavenger failed, skipping..."

      # 5. ë°ì´í„° ì •ì œ ë° í†µí•©
      - name: 2. Run Deduplication Pipeline
        run: |
          echo "ğŸ§¹ Running Deduplication & Merge..."
          python pipeline/deduplicate.py

      # 6. ê²°ê³¼ íŒŒì¼ GitHub Repoì— ì»¤ë°‹/ì—…ë°ì´íŠ¸ (Python ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©)
      - name: 3. Sync to GitHub Repo
        run: |
          echo "ğŸ’¾ Syncing to GitHub Repository..."
          python crawlers_to_github.py

      # 7. (ë³´ë„ˆìŠ¤) ì‹¤í–‰ ê²°ê³¼ CSVë¥¼ Artifactë¡œë„ ì €ì¥ (ë°±ì—…ìš©, ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        if: always()  # ì• ë‹¨ê³„ê°€ ì‹¤íŒ¨í•´ë„ ë¡œê·¸/ê²°ê³¼ëŠ” ë‚¨ê¹€
        with:
          name: raw_terms_clean
          path: output/raw_terms_clean.csv
          retention-days: 7
