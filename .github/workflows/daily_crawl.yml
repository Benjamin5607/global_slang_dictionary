name: Daily Slang Crawl

on:
  schedule:
    - cron: "0 2 * * *"  # ë§¤ì¼ UTC 02:00 (í•œêµ­ ì‹œê°„ ì˜¤ì „ 11:00) ì‹¤í–‰
  workflow_dispatch:     # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

# ë ˆí¬ì§€í† ë¦¬ì— íŒŒì¼(CSV)ì„ ì €ì¥(Push)í•˜ê¸° ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: write

jobs:
  crawl-and-sync:
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. íŒŒì´ì¬ 3.10 ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      # 3. í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      # 4. í¬ë¡¤ëŸ¬ 4ëŒ€ì¥ ì‹¤í–‰ (í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë©ˆì¶”ì§€ ì•ŠìŒ)
      - name: Run Crawlers
        run: |
          mkdir -p output
          echo "ğŸ•·ï¸ Crawling Urban Dictionary..."
          python crawlers/urban_dictionary.py || echo "âš ï¸ Urban failed"
          
          echo "ğŸ•·ï¸ Crawling Wiktionary..."
          python crawlers/wiktionary_slang.py || echo "âš ï¸ Wiktionary failed"
          
          echo "ğŸ•·ï¸ Crawling Reddit..."
          python crawlers/reddit_slang.py || echo "âš ï¸ Reddit failed"
          
          echo "ğŸ•·ï¸ Scavenging GitHub Lists..."
          python crawlers/github_lists.py || echo "âš ï¸ GitHub Lists failed"

      # 5. ë°ì´í„° í†µí•© ë° ì •ì œ (deduplicate)
      - name: Run Deduplication Pipeline
        run: |
          echo "ğŸ§¹ Running Deduplication..."
          python pipeline/deduplicate.py

      # 6. ê²°ê³¼ íŒŒì¼(CSV)ì„ GitHub ë ˆí¬ì— ì»¤ë°‹ & í‘¸ì‹œ
      - name: Commit & Push Changes
        run: |
          git config --global user.name "SlangBot"
          git config --global user.email "bot@slang.com"
          
          # íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì»¤ë°‹
          git add output/raw_terms_clean.csv
          
          # ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ë‚´ì§€ ì•Šê³  ì¡°ìš©íˆ ì¢…ë£Œ (exit 0)
          git commit -m "ğŸ”¥ Daily Update: Slang Data" || exit 0
          
          git push

      # 7. Google Apps Script ê¹¨ìš°ê¸° (Webhook í˜¸ì¶œ)
      - name: Trigger Google Apps Script
        run: |
          echo "ğŸ”” Waking up Google Sheets..."
          curl -L "${{ secrets.GAS_WEBHOOK_URL }}"
